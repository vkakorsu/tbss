{% extends "base.html" %}
{% block content %}
<section class="container">
  <h1>Catalog</h1>
  <form id="catalog-form" method="get" class="filters" style="display:grid;gap:8px;margin:12px 0;grid-template-columns:1fr;">
    <input type="search" name="q" placeholder="Search title, author, tags" value="{{ current.q }}">
    <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr;">
      <select name="genre">
        <option value="">All genres</option>
        {% for g in genres %}
          <option value="{{ g.slug }}" {% if current.genre == g.slug %}selected{% endif %}>{{ g.name }}</option>
        {% endfor %}
      </select>
      <select name="author">
        <option value="">All authors</option>
        {% for a in authors %}
          <option value="{{ a.slug }}" {% if current.author == a.slug %}selected{% endif %}>{{ a.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr;">
      <input type="number" step="0.01" name="min" placeholder="Min price" value="{{ current.min }}">
      <input type="number" step="0.01" name="max" placeholder="Max price" value="{{ current.max }}">
      <select name="avail">
        <option value="">Any availability</option>
        <option value="in" {% if current.avail == 'in' %}selected{% endif %}>In stock</option>
        <option value="out" {% if current.avail == 'out' %}selected{% endif %}>Out of stock</option>
      </select>
    </div>
    <div>
      <button class="btn" type="submit">Filter</button>
      <a class="btn" href="{% url 'catalog:index' %}" style="background:var(--brand-2);color:var(--ink)">Reset</a>
    </div>
  </form>

  <div id="catalog-results">
  {% if books %}
  <div class="cards">
    {% for b in books %}
    <article class="card">
      <a href="{{ b.get_absolute_url }}" style="text-decoration:none;color:inherit;display:block">
        {% if b.cover %}
          <div class="cover" style="background-image:url('{{ b.cover.url }}');background-size:cover;background-position:center"></div>
        {% else %}
          <div class="cover ph"></div>
        {% endif %}
        <h3 style="margin:.5rem 0">{{ b.title }}</h3>
        <p class="muted small">
          {% for a in b.authors.all %}{% if not forloop.first %}, {% endif %}{{ a.name }}{% endfor %}
        </p>
        <p><strong>GH₵ {{ b.price }}</strong> · {% if b.in_stock %}<span style="color:green">In stock</span>{% else %}<span style="color:#a00">Out of stock</span>{% endif %}</p>
      </a>
    </article>
    {% endfor %}
  </div>

  {% if is_paginated %}
  <div class="container" style="margin-top:16px;display:flex;gap:8px;justify-content:center">
    {% if page_obj.has_previous %}
      <a class="btn" href="?page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}
    <span class="small muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="btn" href="?page={{ page_obj.next_page_number }}">Next</a>
    {% endif %}
  </div>
  {% endif %}
  {% else %}
    <p class="muted">No books found. Try adjusting filters.</p>
  {% endif %}
  </div>
</section>

<script>
  (function(){
    const form = document.getElementById('catalog-form');
    const results = document.getElementById('catalog-results');
    if(!form || !results) return;

    function fetchResults(url){
      fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(r=>r.text())
        .then(html=>{
          const tmp = document.createElement('div');
          tmp.innerHTML = html;
          const fresh = tmp.querySelector('#catalog-results');
          if(fresh){ results.innerHTML = fresh.innerHTML; }
        })
        .catch(()=>{});
    }

    function buildUrl(){
      const params = new URLSearchParams(new FormData(form));
      return form.action + (form.action.indexOf('?')===-1 ? '?' : '&') + params.toString();
    }

    const onChange = ()=>{
      fetchResults(buildUrl());
    };

    form.addEventListener('submit', function(e){
      e.preventDefault();
      onChange();
    });

    form.querySelectorAll('input[type="search"], input[type="number"]').forEach(el=>{
      el.addEventListener('input', function(){
        clearTimeout(el._debounceTimer);
        el._debounceTimer = setTimeout(onChange, 250);
      });
    });
    form.querySelectorAll('select').forEach(el=>{
      el.addEventListener('change', onChange);
    });

    // Handle pagination clicks inside results
    results.addEventListener('click', function(e){
      const link = e.target.closest('a');
      if(link && link.closest('#catalog-results') && link.getAttribute('href') && link.getAttribute('href').indexOf('?page=') !== -1){
        e.preventDefault();
        const url = link.href;
        fetchResults(url);
      }
    });
  })();
</script>
{% endblock %}
